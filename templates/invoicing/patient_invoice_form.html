{% extends 'invoicing/base.html' %}

{% block title %}
    {% if object %}Editar Factura de Paciente{% else %}Nueva Factura de Paciente{% endif %} - Sistema de Facturación Médica
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb pt-3">
        <li class="breadcrumb-item"><a href="{% url 'invoicing:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'invoicing:electronic_invoice_list' %}">Facturas Electrónicas</a></li>
        {% if object %}
            <li class="breadcrumb-item"><a href="{% url 'invoicing:electronic_invoice_detail' object.electronic_invoice.pk %}">Factura {{ object.electronic_invoice.invoice_number }}</a></li>
            <li class="breadcrumb-item active">Editar Factura de Paciente</li>
        {% else %}
            <li class="breadcrumb-item active">Nueva Factura de Paciente</li>
        {% endif %}
    </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if object %}Editar Factura de Paciente{% else %}Nueva Factura de Paciente{% endif %}
    </h1>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Electronic Invoice Info -->
        {% if not object %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-receipt"></i> Factura Electrónica de Destino
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Número:</strong> {{ form.electronic_invoice.initial.invoice_number|default:"No especificado" }}
                    </div>
                    <div class="col-md-4">
                        <strong>Fecha:</strong> {{ form.electronic_invoice.initial.date|date:"d/m/Y"|default:"No especificado" }}
                    </div>
                    <div class="col-md-4">
                        <strong>Sucursal:</strong> {{ form.electronic_invoice.initial.branch.name|default:"No especificado" }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Patient Invoice Form -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Información de la Factura de Paciente</h6>
            </div>
            <div class="card-body">
                <form method="post" id="patient-invoice-form" novalidate>
                    {% csrf_token %}
                    
                    {% if form.electronic_invoice.widget.input_type == 'hidden' %}
                        {{ form.electronic_invoice }}
                    {% else %}
                        <div class="mb-3">
                            <label for="{{ form.electronic_invoice.id_for_label }}" class="form-label">{{ form.electronic_invoice.label }}</label>
                            {{ form.electronic_invoice }}
                            {% if form.electronic_invoice.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.electronic_invoice.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.patient.id_for_label }}" class="form-label">{{ form.patient.label }}</label>
                            <div class="input-group">
                                {{ form.patient }}
                                <button type="button" class="btn btn-outline-secondary" id="search-patient-btn">
                                    <i class="bi bi-search"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success" id="create-patient-btn">
                                    <i class="bi bi-plus"></i> Crear
                                </button>
                            </div>
                            {% if form.patient.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.patient.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Seleccione el paciente o búsquelo por nombre/cédula</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.branch.id_for_label }}" class="form-label">{{ form.branch.label }}</label>
                            {{ form.branch }}
                            {% if form.branch.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.branch.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Sucursal donde se realizó el tratamiento</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.invoice_number.id_for_label }}" class="form-label">{{ form.invoice_number.label }}</label>
                            {{ form.invoice_number }}
                            {% if form.invoice_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.invoice_number.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Número interno de factura del paciente</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                            {{ form.date }}
                            {% if form.date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.date.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% if object %}{% url 'invoicing:electronic_invoice_detail' object.electronic_invoice.pk %}{% else %}{% url 'invoicing:electronic_invoice_list' %}{% endif %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            <i class="bi bi-check-circle"></i> 
                            {% if object %}Actualizar{% else %}Crear{% endif %} Factura de Paciente
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Patient Search Modal -->
        <div class="modal fade" id="patientSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Buscar Paciente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="patient-search-input" 
                                   placeholder="Buscar por nombre o apellidos...">
                        </div>
                        <div id="patient-search-results">
                            <div class="text-center text-muted">
                                <i class="bi bi-search fs-3"></i>
                                <p>Escriba para buscar pacientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Patient Modal -->
        <div class="modal fade" id="createPatientModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crear Nuevo Paciente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="create-patient-form">
                            <div class="mb-3">
                                <label for="new-patient-name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="new-patient-name" required>
                            </div>
                            <div class="mb-3">
                                <label for="new-patient-lname1" class="form-label">Primer Apellido</label>
                                <input type="text" class="form-control" id="new-patient-lname1" required>
                            </div>
                            <div class="mb-3">
                                <label for="new-patient-lname2" class="form-label">Segundo Apellido</label>
                                <input type="text" class="form-control" id="new-patient-lname2">
                                <div class="form-text">Campo opcional</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="save-patient-btn">
                            <i class="bi bi-check-circle"></i> Crear Paciente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('patient-invoice-form');
    const submitBtn = document.getElementById('submit-btn');
    const patientSelect = document.querySelector('[name="patient"]');
    const searchBtn = document.getElementById('search-patient-btn');
    const createBtn = document.getElementById('create-patient-btn');
    const modal = new bootstrap.Modal(document.getElementById('patientSearchModal'));
    const createModal = new bootstrap.Modal(document.getElementById('createPatientModal'));
    const searchInput = document.getElementById('patient-search-input');
    const resultsDiv = document.getElementById('patient-search-results');
    
    // Set today's date as default
    const dateField = document.querySelector('[name="date"]');
    if (dateField && !dateField.value) {
        const today = new Date().toISOString().split('T')[0];
        dateField.value = today;
    }
    
    // Auto-generate invoice number suggestion
    const invoiceNumberField = document.querySelector('[name="invoice_number"]');
    if (invoiceNumberField && !invoiceNumberField.value) {
        const now = new Date();
        const suggestion = String(now.getTime()).slice(-6); // Last 6 digits of timestamp
        invoiceNumberField.placeholder = `Ejemplo: PAC-${suggestion}`;
    }
    
    // Form validation
    form.addEventListener('submit', function(e) {
        clearFieldErrors();
        showLoading(submitBtn);
        
        let isValid = true;
        const requiredFields = ['patient', 'invoice_number', 'date'];
        
        requiredFields.forEach(function(fieldName) {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                showFieldError(fieldName, 'Este campo es obligatorio.');
                isValid = false;
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            hideLoading(submitBtn);
            return false;
        }
    });
    
    // Patient search functionality
    searchBtn.addEventListener('click', function() {
        modal.show();
        searchInput.focus();
    });
    
    // Create patient functionality
    createBtn.addEventListener('click', function() {
        createModal.show();
        document.getElementById('new-patient-name').focus();
    });
    
    // Save new patient
    document.getElementById('save-patient-btn').addEventListener('click', function() {
        const name = document.getElementById('new-patient-name').value.trim();
        const lname1 = document.getElementById('new-patient-lname1').value.trim();
        const lname2 = document.getElementById('new-patient-lname2').value.trim();
        
        if (!name || !lname1) {
            alert('Por favor complete los campos obligatorios (Nombre y Primer Apellido).');
            return;
        }
        
        showLoading(this);
        
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                         document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        // Create patient via AJAX
        fetch('/ajax/create-patient/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                name: name,
                lname1: lname1,
                lname2: lname2
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading(document.getElementById('save-patient-btn'));
            
            if (data.success) {
                // Add new patient to select
                const option = document.createElement('option');
                option.value = data.patient.id;
                option.textContent = data.patient.full_name;
                option.selected = true;
                patientSelect.appendChild(option);
                
                // Clear form
                document.getElementById('create-patient-form').reset();
                
                // Close modal
                createModal.hide();
                
                // Show success message
                alert('Paciente creado exitosamente: ' + data.patient.full_name);
            } else {
                alert('Error al crear paciente: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            hideLoading(document.getElementById('save-patient-btn'));
            console.error('Error:', error);
            alert('Error al crear paciente. Por favor intente nuevamente.');
        });
    });
    
    // Search patients via AJAX
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            if (query.length >= 2) {
                searchPatients(query);
            } else {
                resultsDiv.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-search fs-3"></i>
                        <p>Escriba al menos 2 caracteres para buscar</p>
                    </div>
                `;
            }
        }, 300);
    });
    
    function searchPatients(query) {
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm me-2"></div>
                Buscando pacientes...
            </div>
        `;
        
        fetch(`/ajax/patients/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.patients && data.patients.length > 0) {
                    let html = '<div class="list-group">';
                    data.patients.forEach(patient => {
                        html += `
                            <button type="button" class="list-group-item list-group-item-action patient-option" 
                                    data-patient-id="${patient.id}">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${patient.full_name}</strong><br>
                                        <small class="text-muted">Cédula: ${patient.cedula}</small>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="bi bi-arrow-right text-primary"></i>
                                    </div>
                                </div>
                            </button>
                        `;
                    });
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                    
                    // Add click handlers
                    document.querySelectorAll('.patient-option').forEach(option => {
                        option.addEventListener('click', function() {
                            const patientId = this.dataset.patientId;
                            patientSelect.value = patientId;
                            
                            // Trigger change event to update the form
                            patientSelect.dispatchEvent(new Event('change'));
                            
                            modal.hide();
                        });
                    });
                } else {
                    resultsDiv.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="bi bi-person-x fs-3"></i>
                            <p>No se encontraron pacientes con "${query}"</p>
                            <a href="/patients/create/" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-plus"></i> Crear Nuevo Paciente
                            </a>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error searching patients:', error);
                resultsDiv.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle fs-3"></i>
                        <p>Error al buscar pacientes</p>
                    </div>
                `;
            });
    }
});
</script>
{% endblock %}